<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button default-href="/account/orders"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle del Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="!loading && detail; else loadingTpl">
    <div class="order-container">
      <!-- Order Header -->
      <ion-card class="order-header-card" mode="md">
        <ion-card-header>
          <ion-card-title>Pedido #{{ detail!.id }}</ion-card-title>
          <ion-chip 
            [class]="statusChip.cls"
            mode="ios"
            slot="end">
            {{ statusChip.text }}
          </ion-chip>
        </ion-card-header>
      </ion-card>

      <!-- Order Summary -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="receipt-outline"></ion-icon>
            Resumen
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item">
              <ion-label position="stacked">Producto</ion-label>
              <ion-text>{{ detail!.productName }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Precio unitario</ion-label>
              <ion-text>{{ detail!.unitPrice | currency:'COP' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Cantidad</ion-label>
              <ion-text>{{ detail!.quantityRequested }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Subtotal</ion-label>
              <ion-text>{{ detail!.subtotal | currency:'COP' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item total-item">
              <ion-label position="stacked">Total</ion-label>
              <ion-text class="total-amount">{{ detail!.total | currency:'COP' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Creado</ion-label>
              <ion-text>{{ detail!.createdAt | date:'mediumDate':'':'es-CO' }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Delivery Information -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="location-outline"></ion-icon>
            Entrega
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item">
              <ion-label position="stacked">Destinatario</ion-label>
              <ion-text>{{ detail!.recipientName }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Teléfono</ion-label>
              <ion-text>{{ detail!.contactPhone }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Dirección</ion-label>
              <ion-text>
                {{ detail!.addressLine1 }}
                <ng-container *ngIf="detail!.addressLine2">, {{ detail!.addressLine2 }}</ng-container>
              </ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Ciudad</ion-label>
              <ion-text>{{ detail!.cityName || ('#' + detail!.cityId) }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Payment Receipt -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="card-outline"></ion-icon>
            Comprobante de Pago
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ng-container *ngIf="detail!.paymentImageUrl; else noImg">
            <div class="receipt-container">
              <img 
                class="receipt-image" 
                [src]="detail!.paymentImageUrl!" 
                alt="Comprobante"
                (click)="openImageModal()" />
              <div class="upload-date">
                Subido: {{ detail!.paymentUploadedAt | date:'medium' }}
              </div>
            </div>
          </ng-container>
          
          <ng-template #noImg>
            <div class="no-receipt">
              <ion-icon name="image-outline" color="medium" size="large"></ion-icon>
              <ion-text color="medium">No disponible.</ion-text>
            </div>
          </ng-template>

          <!-- Upload Payment Action -->
          <div class="upload-action" *ngIf="canUploadPayment">
            <input 
              type="file" 
              accept="image/*" 
              #paymentInput 
              hidden 
              (change)="onPickPaymentFile($event)" />
            <ion-button 
              expand="block" 
              fill="solid" 
              color="primary"
              (click)="triggerFile(paymentInput)"
              class="upload-button">
              <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
              Subir comprobante
            </ion-button>
            <div class="file-hint">
              Formatos: JPG/PNG/WEBP · Máx {{ MAX_FILE_MB }} MB
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Producer Decision -->
      <ion-card class="order-section-card" mode="md" *ngIf="detail!.producerDecisionAt">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="business-outline"></ion-icon>
            Decisión del Productor
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item" *ngIf="detail!.producerDecisionAt">
              <ion-label position="stacked">Fecha decisión</ion-label>
              <ion-text>{{ detail!.producerDecisionAt | date:'medium' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item" *ngIf="detail!.producerNotes">
              <ion-label position="stacked">Notas del productor</ion-label>
              <ion-text>{{ detail!.producerNotes }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item" *ngIf="detail!.producerDecisionReason">
              <ion-label position="stacked">Motivo</ion-label>
              <ion-text>{{ detail!.producerDecisionReason }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Confirmation Actions -->
      <div class="confirmation-actions" *ngIf="canConfirm">
        <ion-card class="confirmation-card" mode="md">
          <ion-card-content>
            <div class="action-buttons">
              <ion-button 
                expand="block" 
                fill="outline" 
                color="danger"
                [disabled]="confirming"
                (click)="confirm('no')"
                class="action-button">
                <ion-icon slot="start" name="warning-outline"></ion-icon>
                No, hubo problema
              </ion-button>
              
              <ion-button 
                expand="block" 
                fill="solid" 
                color="success"
                [disabled]="confirming"
                (click)="confirm('yes')"
                class="action-button">
                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                Sí, recibido
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Cancel Action -->
      <div class="cancel-actions" *ngIf="canCancel">
        <ion-card class="cancel-card" mode="md">
          <ion-card-content>
            <ion-button 
              expand="block" 
              fill="solid" 
              color="danger"
              (click)="cancel()"
              class="cancel-button">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Cancelar pedido
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Info Message -->
      <div class="info-message" *ngIf="!canConfirm">
        <ion-card class="info-card" mode="md">
          <ion-card-content>
            <ion-item lines="none">
              <ion-icon name="information-circle-outline" color="medium" slot="start"></ion-icon>
              <ion-text color="medium">
                La confirmación aparece cuando el productor marca tu pedido como entregado.
              </ion-text>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </ng-container>

  <!-- Loading Template -->
  <ng-template #loadingTpl>
    <div class="loading-container">
      <ion-card class="skeleton-card" mode="md">
        <ion-card-header>
          <ion-skeleton-text animated style="width: 60%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80px; height: 24px; border-radius: 12px;"></ion-skeleton-text>
        </ion-card-header>
        
        <ion-card-content>
          <ion-skeleton-text animated style="width: 100%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 70%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 90%; height: 16px; margin-bottom: 16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 40px; border-radius: 8px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-template>

  <!-- Image Modal -->
  <ion-modal [isOpen]="showImage" (ionModalDidDismiss)="showImage = false" class="image-modal">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-title>Comprobante de Pago</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showImage = false" color="light">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="modal-content">
        <div class="image-container">
          <img 
            [src]="detail?.paymentImageUrl || ''" 
            alt="Comprobante ampliado"
            class="modal-image" />
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
