<ion-content
  class="fondo-auth safe-page full-viewport"
  [style.background-image]="'url(assets/backgrounds/fondologin.jpg)'"
  style="background-size:cover;background-position:center;--background:transparent"
>
  <div class="auth-viewport">

    <!-- Logo superior -->
    <div class="top-logo-wrap">
      <img src="assets/logo/logo.png" alt="Logo" class="brand-logo" />
    </div>

    <!-- Card con verde suave -->
    <ion-card class="formaForm auth-card">
      <ion-card-content>

        <h3 class="text-center mb-3 titleForm">Regístrate</h3>
        <div class="ion-text-center" style="margin-top:.5rem">
          ¿Ya tienes cuenta?
          <a [routerLink]="['../login']" class="link">Inicia Sesión</a>
        </div>

        <!-- Paso 1 -->
        <form [formGroup]="credentialsForm" *ngIf="currentStep === 1" class="mt-12">
          <!-- Email -->
          <label for="email" class="label">Correo Electrónico</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="email" type="email" formControlName="email" placeholder="Correo Electrónico"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="credentialsForm.get('email')?.errors && credentialsForm.get('email')?.touched" class="note">
            <ng-container *ngIf="credentialsForm.get('email')?.hasError('required')">El email es obligatorio.</ng-container>
            <ng-container *ngIf="credentialsForm.get('email')?.hasError('email')">Formato de email no válido.</ng-container>
            <ng-container *ngIf="credentialsForm.get('email')?.hasError('maxlength')">El email no debe superar 150 caracteres.</ng-container>
            <ng-container *ngIf="credentialsForm.get('email')?.hasError('pattern')">El email no puede estar en blanco.</ng-container>
          </ion-note>

          <!-- Password -->
          <label for="password" class="label mt-12">Contraseña</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="password" type="password" formControlName="password" placeholder="Contraseña"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="credentialsForm.get('password')?.errors && credentialsForm.get('password')?.touched" class="note">
            <ng-container *ngIf="credentialsForm.get('password')?.hasError('required')">La contraseña es obligatoria.</ng-container>
            <ng-container *ngIf="credentialsForm.get('password')?.hasError('pattern')">La contraseña no debe contener espacios.</ng-container>
            <ng-container *ngIf="credentialsForm.get('password')?.hasError('passwordPolicy')">Mínimo 6 caracteres y al menos 1 mayúscula.</ng-container>
          </ion-note>

          <!-- Confirm Password -->
          <label for="confirmPassword" class="label mt-12">Confirmar Contraseña</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="confirmPassword" type="password" formControlName="confirmPassword" placeholder="Confirmar Contraseña"></ion-input>
          </ion-item>
          <ion-note color="danger"
                    *ngIf="(credentialsForm.get('confirmPassword')?.touched || credentialsForm.get('password')?.touched) && credentialsForm.hasError('passwordMismatch')"
                    class="note">
            Las contraseñas no coinciden.
          </ion-note>

          <ion-button type="button" expand="block" class="btn-custom mt-12" (click)="nextStep()" [disabled]="credentialsForm.invalid">
            Siguiente
          </ion-button>
        </form>

        <!-- Paso 2 -->
        <form [formGroup]="basicForm" *ngIf="currentStep === 2" class="mt-12">
          <!-- Nombre -->
          <label for="firstName" class="label">Nombre</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="firstName" type="text" formControlName="firstName" placeholder="Nombre"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="basicForm.get('firstName')?.errors && basicForm.get('firstName')?.touched" class="note">
            <ng-container *ngIf="basicForm.get('firstName')?.hasError('required')">El nombre es obligatorio.</ng-container>
            <ng-container *ngIf="basicForm.get('firstName')?.hasError('minlength')">Debe tener al menos 2 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('firstName')?.hasError('maxlength')">No debe superar 50 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('firstName')?.hasError('pattern')">Solo debe contener letras y espacios.</ng-container>
          </ion-note>

          <!-- Apellido -->
          <label for="lastName" class="label mt-12">Apellido</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="lastName" type="text" formControlName="lastName" placeholder="Apellido"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="basicForm.get('lastName')?.errors && basicForm.get('lastName')?.touched" class="note">
            <ng-container *ngIf="basicForm.get('lastName')?.hasError('required')">El apellido es obligatorio.</ng-container>
            <ng-container *ngIf="basicForm.get('lastName')?.hasError('minlength')">Debe tener al menos 2 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('lastName')?.hasError('maxlength')">No debe superar 50 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('lastName')?.hasError('pattern')">Solo debe contener letras y espacios.</ng-container>
          </ion-note>

          <!-- Identificación -->
          <label for="identification" class="label mt-12">Número de Identidad</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="identification" type="text" formControlName="identification" placeholder="Número de Identidad"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="basicForm.get('identification')?.errors && basicForm.get('identification')?.touched" class="note">
            <ng-container *ngIf="basicForm.get('identification')?.hasError('required')">La identificación es obligatoria.</ng-container>
            <ng-container *ngIf="basicForm.get('identification')?.hasError('minlength')">Debe tener al menos 5 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('identification')?.hasError('maxlength')">No debe superar 20 caracteres.</ng-container>
            <ng-container *ngIf="basicForm.get('identification')?.hasError('pattern')">Solo puede contener letras, números, punto y guion.</ng-container>
          </ion-note>

          <div style="display:flex;gap:.5rem;margin-top:.75rem">
            <ion-button fill="outline" (click)="prevStep()">Volver</ion-button>
            <ion-button class="btn-custom" (click)="nextStep()" [disabled]="basicForm.invalid">Siguiente</ion-button>
          </div>
        </form>

        <!-- Paso 3 -->
        <form [formGroup]="contactForm" *ngIf="currentStep === 3" class="mt-12">
          <!-- Teléfono -->
          <label for="phoneNumber" class="label">Número de Teléfono</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="phoneNumber" type="tel" formControlName="phoneNumber" placeholder="Número de Teléfono"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="contactForm.get('phoneNumber')?.errors && contactForm.get('phoneNumber')?.touched" class="note">
            <ng-container *ngIf="contactForm.get('phoneNumber')?.hasError('required')">El teléfono es obligatorio.</ng-container>
            <ng-container *ngIf="contactForm.get('phoneNumber')?.hasError('maxlength')">No debe superar 25 caracteres.</ng-container>
            <ng-container *ngIf="contactForm.get('phoneNumber')?.hasError('pattern')">Debe tener entre 7 y 15 dígitos.</ng-container>
          </ion-note>

          <!-- Dirección -->
          <label for="address" class="label mt-12">Dirección</label>
          <ion-item lines="none" class="input-custom">
            <ion-input id="address" type="text" formControlName="address" placeholder="Dirección"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="contactForm.get('address')?.errors && contactForm.get('address')?.touched" class="note">
            <ng-container *ngIf="contactForm.get('address')?.hasError('required')">La dirección es obligatoria.</ng-container>
            <ng-container *ngIf="contactForm.get('address')?.hasError('minlength')">Debe tener al menos 5 caracteres.</ng-container>
            <ng-container *ngIf="contactForm.get('address')?.hasError('maxlength')">No debe superar 120 caracteres.</ng-container>
          </ion-note>

          <!-- Departamento / Ciudad -->
        <div class="dept-city-row">
  <div class="dept-col">
    <label for="departmentId" class="label">Departamento</label>
    <ion-item lines="none" class="input-custom">
      <ion-select interface="popover" formControlName="departmentId" placeholder="Selecciona un departamento">
        <ion-select-option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</ion-select-option>
      </ion-select>
    </ion-item>
  </div>

  <div class="city-col">
    <label for="cityId" class="label">Ciudad</label>
    <ion-item lines="none" class="input-custom">
      <ion-select interface="popover" formControlName="cityId" placeholder="Selecciona una ciudad">
        <ion-select-option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</ion-select-option>
      </ion-select>
    </ion-item>
    <ion-note color="danger" *ngIf="contactForm.get('cityId')?.invalid && contactForm.get('cityId')?.touched" class="note">
      Debe seleccionar una ciudad válida.
    </ion-note>
  </div>
</div>


          <div style="display:flex;gap:.5rem;margin-top:.75rem">
            <ion-button fill="outline" (click)="prevStep()">Volver</ion-button>
            <ion-button class="btn-custom" (click)="register()" [disabled]="contactForm.invalid || loading">
              Registrarse
            </ion-button>
          </div>
        </form>

      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
