<ion-content [fullscreen]="true" class="page-bg product-content">
  <div class="page-shell product-shell">
    <div class="page-topbar">
      <button type="button" class="back-btn" (click)="goBack()" aria-label="Volver">
        <ion-icon name="arrow-back"></ion-icon>
      </button>
      <h1 class="topbar-title">Gestion de fincas</h1>
    </div>

    <section class="filters-card">
      <div class="filters-header">
       <h2>Mis Fincas</h2>
        <app-button
          class="btn-inline"
          color="secondary"
          [text]="'Filtros'"
          [icon]="showFilters ? 'chevron-up-outline' : 'chevron-down-outline'"
          type="button"
          (clicked)="toggleFilters()">
        </app-button>
      </div>

      <ion-searchbar
        class="search-input"
        placeholder="Buscar fincas o productores"
        [value]="searchCtrl.value"
        (ionInput)="onSearch($event)"
        show-clear-button="always"
        debounce="250">
      </ion-searchbar>

      <div class="filters-body" [class.filters-body--collapsed]="!showFilters">
        <div class="filter-field">
          <label class="filter-label">Departamento</label>
          <ion-item lines="none">
            <ion-select
              interface="popover"
              placeholder="Selecciona"
              [disabled]="isLoadingDepartments"
              [formControl]="departmentCtrl"
              (ionChange)="onDepartmentSelect($event)">
              <ion-select-option *ngFor="let d of departments" [value]="d.id">
                {{ d.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="filter-field">
          <label class="filter-label">Ciudad</label>
          <ion-item lines="none">
            <ion-select
              interface="popover"
              placeholder="Selecciona"
              [disabled]="isLoadingCities || cityCtrl.disabled"
              [formControl]="cityCtrl"
              (ionChange)="onCitySelect($event)">
              <ion-select-option *ngFor="let c of cities" [value]="c.id">
                {{ c.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <app-button
          class="btn-inline"
          color="secondary"
          icon="refresh"
          [text]="'Limpiar'"
          type="button"
          [disabled]="!searchCtrl.value && !departmentCtrl.value && !cityCtrl.value"
          (clicked)="clearFilters()">
        </app-button>
      </div>
    </section>

    <section class="results-card">
      <ion-progress-bar *ngIf="loadingFarms" type="indeterminate"></ion-progress-bar>

      <ng-container *ngIf="!loadingFarms && pagedFarms.length; else emptyState">
        <app-container-card-flex
          [type]="'farm'"
          [items]="pagedFarms"
          [showActions]="true"
          (editFarm)="onEdit($event)"
          (deleteFarm)="onDelete($event)"
          (viewFarm)="onView($event)">
        </app-container-card-flex>
      </ng-container>

      <div class="pager" *ngIf="!loadingFarms && totalPages > 1">
        <app-button
          class="btn-inline"
          color="secondary"
          icon="chevron-back-outline"
          [text]="''"
          type="button"
          [disabled]="isFirstPage"
          (clicked)="onPrevPage()">
        </app-button>
        <div class="pager__label">
          <ion-icon name="swap-horizontal-outline" class="pager__hint-icon"></ion-icon>
          <span>{{ pageIndex + 1 }} / {{ totalPages }}</span>
        </div>
        <app-button
          class="btn-inline"
          color="secondary"
          icon="chevron-forward-outline"
          [text]="''"
          type="button"
          [disabled]="isLastPage"
          (clicked)="onNextPage()">
        </app-button>
      </div>
    </section>
  </div>

  <ng-template #emptyState>
    <div class="empty-state">
      <ion-icon name="home-outline"></ion-icon>
      <p *ngIf="!loadingFarms">Aun no registras fincas.</p>
      <p *ngIf="loadingFarms">Cargando fincas...</p>
      <app-button
        class="btn-inline"
        color="secondary"
        [text]="'Crear finca'"
        type="button"
        (clicked)="onCreate()">
      </app-button>
    </div>
  </ng-template>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="success" (click)="onCreate()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>



