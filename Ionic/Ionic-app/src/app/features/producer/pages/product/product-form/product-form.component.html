<ion-header>
  <ion-toolbar color="success">
    <ion-title>{{ isEdit ? 'Editar Producto' : 'Nuevo Producto' }}</ion-title>
  </ion-toolbar>

  <ion-segment [formControl]="stepControl" mode="md" class="segment-bar">
    <ion-segment-button value="general">
      <ion-label>Generales</ion-label>
    </ion-segment-button>
    <ion-segment-button value="detalles">
      <ion-label>Detalles</ion-label>
    </ion-segment-button>
    <ion-segment-button value="imagenes">
      <ion-label>Imágenes</ion-label>
    </ion-segment-button>
  </ion-segment>
</ion-header>

<ion-content [fullscreen]="true" class="form-content">
  <!-- Paso 1: Generales -->
  <section *ngIf="stepControl.value === 'general'" class="section-card">
    <h2 class="section-title">Datos Generales</h2>

    <form [formGroup]="generalGroup">
      <ion-input label="Nombre" labelPlacement="floating" formControlName="name" fill="outline"></ion-input>

      <ion-input label="Precio" labelPlacement="floating" type="number" formControlName="price" fill="outline"></ion-input>

      <ion-input label="Unidad" labelPlacement="floating" formControlName="unit" fill="outline"></ion-input>

      <ion-input label="Producción" labelPlacement="floating" formControlName="production" fill="outline"></ion-input>

      <ion-textarea label="Descripción" labelPlacement="floating" rows="3" formControlName="description" fill="outline"></ion-textarea>
    </form>
  </section>

  <!-- Paso 2: Detalles -->
  <section *ngIf="stepControl.value === 'detalles'" class="section-card">
    <h2 class="section-title">Detalles del Producto</h2>

    <form [formGroup]="detallesGroup">
      <ion-input label="Stock Disponible" labelPlacement="floating" type="number" formControlName="stock" fill="outline"></ion-input>

      <ion-select label="Estado" labelPlacement="floating" formControlName="status" fill="outline">
        <ion-select-option [value]="true">Activo</ion-select-option>
        <ion-select-option [value]="false">Inactivo</ion-select-option>
      </ion-select>

      <ion-select label="Envío incluido" labelPlacement="floating" formControlName="shippingIncluded" fill="outline">
        <ion-select-option [value]="true">Sí</ion-select-option>
        <ion-select-option [value]="false">No</ion-select-option>
      </ion-select>

      <ion-select label="Categoría" labelPlacement="floating" formControlName="categoryId" fill="outline">
        <ion-select-option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</ion-select-option>
      </ion-select>

      <ion-select label="Fincas" labelPlacement="floating" multiple formControlName="farmIds" fill="outline">
        <ion-select-option *ngFor="let f of farms" [value]="f.id">{{ f.name }}</ion-select-option>
      </ion-select>
    </form>
  </section>

  <!-- Paso 3: Imágenes -->
  <section *ngIf="stepControl.value === 'imagenes'" class="section-card">
    <h2 class="section-title">Imágenes del Producto</h2>

    <div class="upload-box" (click)="fileInput.click()">
      <input type="file" #fileInput accept="image/*" multiple hidden (change)="onFileChange($event)" />
      <div class="upload-inner">
        <ion-icon name="cloud-upload-outline" class="upload-icon"></ion-icon>
        <h3>Subir imagen</h3>
        <p>Presiona para poder subir una imagen</p>
        <ion-button color="medium" fill="solid" size="small">Subir</ion-button>
      </div>
    </div>

    <div class="images-preview" *ngIf="imagesPreview.length || existingImages.length">
      <div class="img-container" *ngFor="let img of imagesPreview; let i = index">
        <img [src]="img" />
        <ion-button fill="clear" color="danger" (click)="removeImage(i)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </div>

      <div class="img-container" *ngFor="let img of existingImages; let i = index">
        <img [src]="img.imageUrl" />
        <ion-button fill="clear" color="danger" (click)="removeImage(i, true)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </div>
    </div>
  </section>

  <!-- Acciones -->
  <div class="actions">
    <ion-button color="medium" (click)="goBack()">Cancelar</ion-button>
    <ion-button color="success" (click)="submit()" [disabled]="isLoading">
      {{ isEdit ? 'Actualizar' : 'Crear' }}
    </ion-button>
  </div>
</ion-content>
