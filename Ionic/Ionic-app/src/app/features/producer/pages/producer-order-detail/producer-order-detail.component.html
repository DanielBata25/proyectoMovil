<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button default-href="/account/producer/orders"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle del Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="!loading && detail; else loadingTpl">
    <div class="order-container">
      <!-- Order Header -->
      <ion-card class="order-header-card" mode="md">
        <ion-card-header>
          <ion-card-title>Pedido #{{ detail!.id }}</ion-card-title>
          <ion-chip 
            [class]="statusChip.cls"
            mode="ios"
            slot="end">
            {{ statusChip.text }}
          </ion-chip>
        </ion-card-header>
      </ion-card>

      <!-- Order Summary -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="receipt-outline"></ion-icon>
            Resumen
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item">
              <ion-label position="stacked">Producto</ion-label>
              <ion-text>{{ detail!.productName }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Precio unitario</ion-label>
              <ion-text>{{ detail!.unitPrice | currency:'COP' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Cantidad</ion-label>
              <ion-text>{{ detail!.quantityRequested }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Subtotal</ion-label>
              <ion-text>{{ detail!.subtotal | currency:'COP' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item total-item">
              <ion-label position="stacked">Total</ion-label>
              <ion-text class="total-amount">{{ detail!.total | currency:'COP' }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Delivery Information -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="location-outline"></ion-icon>
            Entrega
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item">
              <ion-label position="stacked">Destinatario</ion-label>
              <ion-text>{{ detail!.recipientName }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Teléfono</ion-label>
              <ion-text>{{ detail!.contactPhone }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Dirección</ion-label>
              <ion-text>
                {{ detail!.addressLine1 }}
                <ng-container *ngIf="detail!.addressLine2">, {{ detail!.addressLine2 }}</ng-container>
              </ion-text>
            </ion-item>
            
            <ion-item class="detail-item">
              <ion-label position="stacked">Ciudad</ion-label>
              <ion-text>{{ detail!.cityName || ('#' + detail!.cityId) }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Payment Receipt -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="card-outline"></ion-icon>
            Comprobante de Pago
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ng-container *ngIf="detail!.paymentImageUrl; else noImg">
            <div class="receipt-container">
              <img 
                class="receipt-image" 
                [src]="detail!.paymentImageUrl!" 
                alt="Comprobante"
                (click)="openImage()" />
              <div class="upload-date">
                <small>Click para abrir en nueva pestaña</small>
              </div>
            </div>
          </ng-container>
          
          <ng-template #noImg>
            <div class="no-receipt">
              <ion-icon name="image-outline" color="medium" size="large"></ion-icon>
              <ion-text color="medium">
                Sin comprobante
                <ng-container *ngIf="detail!.status === 'AcceptedAwaitingPayment'">
                  (el cliente aún no lo ha subido).
                </ng-container>
              </ion-text>
            </div>
          </ng-template>
        </ion-card-content>
      </ion-card>

      <!-- Times Information -->
      <ion-card class="order-section-card" mode="md">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="time-outline"></ion-icon>
            Tiempos
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="none">
            <ion-item class="detail-item">
              <ion-label position="stacked">Creado</ion-label>
              <ion-text>{{ detail!.createAt | date:'mediumDate':'':'es-CO' }}</ion-text>
            </ion-item>
            
            <ion-item class="detail-item" *ngIf="detail!.producerDecisionAt">
              <ion-label position="stacked">Decisión productor</ion-label>
              <ion-text>{{ detail!.producerDecisionAt | date:'mediumDate':'':'es-CO' }}</ion-text>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Producer Actions -->
      <div class="producer-actions" *ngIf="canAcceptReject">
        <ion-card class="action-card" mode="md">
          <ion-card-header>
            <ion-card-title class="section-title">
              <ion-icon name="build-outline"></ion-icon>
              Acciones Disponibles
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <div class="action-buttons">
              <ion-button 
                expand="block" 
                fill="outline" 
                color="danger"
                [disabled]="processing"
                (click)="reject()"
                class="action-button">
                <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                Rechazar
              </ion-button>
              
              <ion-button 
                expand="block" 
                fill="solid" 
                color="primary"
                [disabled]="processing"
                (click)="accept()"
                class="action-button">
                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                Aceptar
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <div class="producer-actions" *ngIf="canManageLogistics">
        <ion-card class="action-card" mode="md">
          <ion-card-header>
            <ion-card-title class="section-title">
              <ion-icon name="navigate-outline"></ion-icon>
              Actualizar estado
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <div class="action-buttons">
              <ion-button 
                *ngIf="canMarkPreparing"
                expand="block" 
                fill="outline" 
                color="warning"
                [disabled]="processing"
                (click)="markPreparing()"
                class="action-button">
                <ion-icon slot="start" name="construct-outline"></ion-icon>
                Marcar preparando
              </ion-button>

              <ion-button 
                *ngIf="canMarkDispatched"
                expand="block" 
                fill="outline" 
                color="tertiary"
                [disabled]="processing"
                (click)="markDispatched()"
                class="action-button">
                <ion-icon slot="start" name="rocket-outline"></ion-icon>
                Marcar despachado
              </ion-button>

              <ion-button 
                *ngIf="canMarkDelivered"
                expand="block" 
                fill="solid" 
                color="success"
                [disabled]="processing"
                (click)="markDelivered()"
                class="action-button">
                <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
                Marcar entregado
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Info Message -->
      <div class="info-message" *ngIf="!canAcceptReject && !canManageLogistics">
        <ion-card class="info-card" mode="md">
          <ion-card-content>
            <ion-item lines="none">
              <ion-icon name="information-circle-outline" color="medium" slot="start"></ion-icon>
              <ion-text color="medium">
                No hay acciones disponibles para el estado actual.
              </ion-text>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </ng-container>

  <!-- Loading Template -->
  <ng-template #loadingTpl>
    <div class="loading-container">
      <ion-card class="skeleton-card" mode="md">
        <ion-card-header>
          <ion-skeleton-text animated style="width: 60%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80px; height: 24px; border-radius: 12px;"></ion-skeleton-text>
        </ion-card-header>
        
        <ion-card-content>
          <ion-skeleton-text animated style="width: 100%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 70%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 90%; height: 16px; margin-bottom: 16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 40px; border-radius: 8px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-template>
</ion-content>
