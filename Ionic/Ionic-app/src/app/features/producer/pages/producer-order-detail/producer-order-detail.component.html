<ion-content [fullscreen]="true" class="page-bg producer-order-detail-content">
  <div class="page-shell product-shell order-shell">
    <!-- Título de la página -->
    <h1 class="page-title">Detalle del Pedido</h1>
    
    <ng-container *ngIf="!loading && detail; else loadingTpl">
    <div class="order-container">
      <ion-card class="order-detail-card" mode="md">
        <ion-card-header>
          <div class="card-header">
            <ion-card-title>Pedido #{{ detail!.id }}</ion-card-title>
            <ion-chip [class]="statusChip.cls" mode="ios">
              {{ statusChip.text }}
            </ion-chip>
          </div>
        </ion-card-header>

        <ion-card-content>
          <section class="detail-section">
            <div class="section-heading">
              <ion-icon name="receipt-outline"></ion-icon>
              <span>Resumen</span>
            </div>

            <div class="detail-grid">
              <div class="detail-field">
                <span class="field-label">Producto</span>
                <span class="field-value">{{ detail!.productName }}</span>
              </div>

              <div class="detail-field">
                <span class="field-label">Precio unitario</span>
                <span class="field-value">{{ detail!.unitPrice | currency:'COP' }}</span>
              </div>

              <div class="detail-field">
                <span class="field-label">Cantidad</span>
                <span class="field-value">{{ detail!.quantityRequested }}</span>
              </div>

              <div class="detail-field">
                <span class="field-label">Subtotal</span>
                <span class="field-value">{{ detail!.subtotal | currency:'COP' }}</span>
              </div>

              <div class="detail-field total-field">
                <span class="field-label">Total</span>
                <span class="field-value highlighted">{{ detail!.total | currency:'COP' }}</span>
              </div>
            </div>
          </section>

          <section class="detail-section">
            <div class="section-heading">
              <ion-icon name="location-outline"></ion-icon>
              <span>Entrega</span>
            </div>

            <div class="detail-grid">
              <div class="detail-field">
                <span class="field-label">Destinatario</span>
                <span class="field-value">{{ detail!.recipientName }}</span>
              </div>

              <div class="detail-field">
                <span class="field-label">Teléfono</span>
                <span class="field-value">{{ detail!.contactPhone }}</span>
              </div>

              <div class="detail-field">
                <span class="field-label">Dirección</span>
                <span class="field-value">
                  {{ detail!.addressLine1 }}
                  <ng-container *ngIf="detail!.addressLine2">, {{ detail!.addressLine2 }}</ng-container>
                </span>
              </div>

              <div class="detail-field">
                <span class="field-label">Ciudad</span>
                <span class="field-value">{{ detail!.cityName || ('#' + detail!.cityId) }}</span>
              </div>
            </div>
          </section>

          <section class="detail-section">
            <div class="section-heading">
              <ion-icon name="card-outline"></ion-icon>
              <span>Comprobante de Pago</span>
            </div>

            <ng-container *ngIf="detail!.paymentImageUrl; else noImg">
              <div class="receipt-container">
                <div class="receipt-preview" (click)="openImage()">
                  <img 
                    class="receipt-image" 
                    [src]="detail!.paymentImageUrl!" 
                    alt="Comprobante" />
                  <div class="preview-overlay">
                    <ion-icon name="expand-outline"></ion-icon>
                    <span>Ver comprobante</span>
                  </div>
                </div>
                <div class="upload-date">
                  <small>Click para abrir en nueva pestaña</small>
                </div>
              </div>
            </ng-container>
            
            <ng-template #noImg>
              <div class="no-receipt">
                <ion-icon name="image-outline" color="medium" size="large"></ion-icon>
                <ion-text color="medium">
                  Sin comprobante
                  <ng-container *ngIf="detail!.status === 'AcceptedAwaitingPayment'">
                    (el cliente aún no lo ha subido).
                  </ng-container>
                </ion-text>
              </div>
            </ng-template>
          </section>

          <section class="detail-section">
            <div class="section-heading">
              <ion-icon name="time-outline"></ion-icon>
              <span>Tiempos</span>
            </div>

            <div class="detail-grid">
              <div class="detail-field">
                <span class="field-label">Creado</span>
                <span class="field-value">{{ detail!.createAt | date:'mediumDate':'':'es-CO' }}</span>
              </div>

              <div class="detail-field" *ngIf="detail!.producerDecisionAt">
                <span class="field-label">Decisión productor</span>
                <span class="field-value">{{ detail!.producerDecisionAt | date:'mediumDate':'':'es-CO' }}</span>
              </div>
            </div>
          </section>

          <section class="detail-section rating-section" *ngIf="detail">
            <div class="section-heading">
              <ion-icon name="star-outline"></ion-icon>
              <span>Calificar al cliente</span>
            </div>

            <div class="rating-stars">
              <button
                type="button"
                class="star"
                *ngFor="let s of stars"
                [class.filled]="rating >= s"
                [disabled]="savingRating"
                (click)="setRating(s)"
                [attr.aria-label]="'Calificación ' + s"
              >
                ★
              </button>
              <span class="rating-label">
                {{ rating ? (rating + '/5') : 'Toca para calificar' }}
              </span>
            </div>

            <ion-textarea
              label="Comentario (opcional)"
              labelPlacement="stacked"
              placeholder="Escribe un comentario para el cliente..."
              [autoGrow]="true"
              [(ngModel)]="comment"
              [disabled]="savingRating"
            ></ion-textarea>

            <div class="rating-actions">
              <app-button
                text="Guardar calificación"
                color="primary"
                icon="star"
                [disabled]="savingRating"
                (clicked)="onRateCustomer()"
                style="--app-button-margin:0"
              ></app-button>
              <ion-note *ngIf="isAlreadyRated" color="medium">
                Ya habías calificado este pedido; puedes actualizar la nota.
              </ion-note>
            </div>
          </section>

          <section class="detail-section" *ngIf="canAcceptReject">
            <div class="section-heading">
              <ion-icon name="build-outline"></ion-icon>
              <span>Acciones disponibles</span>
            </div>

            <div class="action-buttons">
              <app-button
                text="Rechazar"
                color="danger"
                icon="close-circle-outline"
                [disabled]="processing"
                (clicked)="reject()"
                style="--app-button-margin:0"></app-button>

              <app-button
                text="Aceptar"
                color="primary"
                icon="checkmark-circle-outline"
                [disabled]="processing"
                (clicked)="accept()"
                style="--app-button-margin:0"></app-button>
            </div>
          </section>

          <section class="detail-section" *ngIf="canManageLogistics">
            <div class="section-heading">
              <ion-icon name="navigate-outline"></ion-icon>
              <span>Actualizar estado</span>
            </div>

            <div class="action-buttons">
              <app-button
                *ngIf="canMarkPreparing"
                text="Marcar preparando"
                color="warning"
                icon="construct-outline"
                [disabled]="processing"
                (clicked)="markPreparing()"
                style="--app-button-margin:0"></app-button>

              <app-button
                *ngIf="canMarkDispatched"
                text="Marcar despachado"
                color="tertiary"
                icon="rocket-outline"
                [disabled]="processing"
                (clicked)="markDispatched()"
                style="--app-button-margin:0"></app-button>

              <app-button
                *ngIf="canMarkDelivered"
                text="Marcar entregado"
                color="success"
                icon="checkmark-done-outline"
                [disabled]="processing"
                (clicked)="markDelivered()"
                style="--app-button-margin:0"></app-button>
            </div>
          </section>

          <section class="detail-section info-section" *ngIf="!canAcceptReject && !canManageLogistics">
            <div class="info-message">
              <ion-icon name="information-circle-outline"></ion-icon>
              <p>No hay acciones disponibles para el estado actual.</p>
            </div>
          </section>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-container>

  <!-- Loading Template -->
  <ng-template #loadingTpl>
    <div class="loading-container">
      <ion-card class="skeleton-card" mode="md">
        <ion-card-header>
          <ion-skeleton-text animated style="width: 60%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80px; height: 24px; border-radius: 12px;"></ion-skeleton-text>
        </ion-card-header>
        
        <ion-card-content>
          <ion-skeleton-text animated style="width: 100%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 70%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 90%; height: 16px; margin-bottom: 16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 40px; border-radius: 8px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-template>

</div>

  <!-- Botón flotante de chat (reutiliza estilo app-fab-add) -->
  <button
    type="button"
    class="app-fab-add chat-fab"
    *ngIf="detail"
    (click)="toggleChat()"
    aria-label="Abrir chat"
  >
    <ion-icon name="chatbubbles-outline"></ion-icon>
  </button>

  <!-- Modal de chat -->
  <ion-modal
    [isOpen]="showChat"
    (didDismiss)="showChat = false"
    class="chat-modal"
  >
    <ng-template>
      <ion-content class="chat-modal-content">
        <app-order-chat [orderCode]="code"></app-order-chat>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
