<ion-header translucent="true">
  <ion-toolbar>
    <ion-title>Productos Disponibles</ion-title>
  </ion-toolbar>

  <!-- Filtros / búsqueda -->
  <ion-toolbar class="filters-toolbar">
    <ion-searchbar
      placeholder="Nombre del producto o productor"
      (ionInput)="onSearch($event)"
      [value]="searchCtrl.value"
      show-clear-button="always"
      debounce="300"
    ></ion-searchbar>

    <ion-buttons slot="end" class="filters-actions">
      <ion-button fill="clear" (click)="toggleFilters()">
        <ion-icon name="filter-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" [disabled]="!breadcrumb.length" (click)="clearFilter()" aria-label="Limpiar filtro">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filtro de Categorías (desplegable) -->
  <ion-toolbar *ngIf="showFilters" class="filters-panel">
    <ion-item lines="none">
      <ion-label>Selecciona una categoría</ion-label>
      <ion-select
        [disabled]="isLoadingCategories || atLeaf"
        interface="popover"
        placeholder="Categoría"
        [value]="categoryCtrl.value"
        (ionChange)="onSelectCategory($event.detail.value)"
      >
        <ion-select-option
          *ngFor="let c of categories; trackBy: trackById"
          [value]="c.id"
        >
          <div class="opt">
            <span>{{ c.name }}</span>
            <ion-icon *ngIf="c.hasChildren" name="chevron-forward-outline"></ion-icon>
          </div>
        </ion-select-option>
      </ion-select>
    </ion-item>
  </ion-toolbar>

  <!-- Breadcrumb -->
  <ion-toolbar class="breadcrumb-bar">
    <ion-buttons>
      <ion-chip color="medium" outline (click)="clearFilter()">
        <ion-label>Todas</ion-label>
      </ion-chip>

      <ng-container *ngFor="let crumb of breadcrumb; let i = index; trackBy: trackById">
        <ion-icon name="chevron-forward-outline" class="crumb-sep"></ion-icon>

        <ion-chip *ngIf="i < breadcrumb.length - 1; else last"
                  color="medium" outline
                  (click)="onBreadcrumbClick(i)">
          <ion-label>{{ crumb.name }}</ion-label>
        </ion-chip>

        <ng-template #last>
          <ion-chip color="primary">
            <ion-label>{{ crumb.name }}</ion-label>
          </ion-chip>
        </ng-template>
      </ng-container>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding page">
  <!-- Loading -->
  <ion-progress-bar *ngIf="isLoadingProducts" type="indeterminate" class="mb-3"></ion-progress-bar>

  <!-- Resultados -->
  <ion-card class="results-card">
    <ion-card-content>
      <app-container-card-flex
        [items]="pagedProducts"
        [type]="'product'"
        [showFavorite]="true">
      </app-container-card-flex>

      <div *ngIf="!isLoadingProducts && products?.length === 0" class="empty">
        <ion-icon name="cube-outline"></ion-icon>
        <div>Sin productos para esta categoría.</div>
      </div>

      <!-- Infinite Scroll (reemplaza al paginador de Material) -->
      <ion-infinite-scroll
        threshold="120px"
        [disabled]="!canLoadMore"
        (ionInfinite)="loadMore($event)">
        <ion-infinite-scroll-content
          loadingSpinner="crescent"
          loadingText="Cargando más...">
        </ion-infinite-scroll-content>
      </ion-infinite-scroll>
    </ion-card-content>
  </ion-card>
</ion-content>
