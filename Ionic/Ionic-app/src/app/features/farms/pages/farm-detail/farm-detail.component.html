<ion-content [fullscreen]="true" class="page-bg" forceOverscroll="false">
  <div class="page-shell detail-shell">
    <div class="center" *ngIf="loading">
      <ion-spinner name="crescent"></ion-spinner>
    </div>

    <section class="detail-card" *ngIf="!loading && !error && farm as farmDetail; else errorState">
      <h1 class="page-title">Detalle de la finca</h1>

      <div class="hero-swiper">
        <ng-container *ngIf="galleryImages.length; else noImg">
          <swiper-container
            #swiperRef
            init="false"
            *ngIf="galleryImages.length > 1; else singleImage"
            [attr.slides-per-view]="slidesOpts.slidesPerView"
            [attr.space-between]="slidesOpts.spaceBetween"
            [attr.pagination]="slidesOpts.pagination"
            [attr.autoplay]="'true'"
            [attr.autoplay-delay]="'4000'"
            [attr.autoplay-disable-on-interaction]="'false'">
            <swiper-slide *ngFor="let url of galleryImages">
              <img
                [src]="url"
                alt="Imagen de la finca"
                class="hero-img" />
            </swiper-slide>
          </swiper-container>

          <ng-template #singleImage>
            <img
              [src]="galleryImages[0]"
              alt="Imagen de la finca"
              class="hero-img hero-img--static" />
          </ng-template>
        </ng-container>
      </div>

      <ng-template #noImg>
        <div class="no-img">Sin fotografías registradas</div>
      </ng-template>

      <div class="block">
        <h2 class="title">{{ farmDetail.name }}</h2>
        <p class="location">
          <ion-icon name="location-outline"></ion-icon>
          {{ farmDetail.cityName }}, {{ farmDetail.departmentName }}
        </p>
      </div>

      <div class="block facts">
        <div class="pair">
          <div class="lbl">Productor</div>
          <div class="val">{{ farmDetail.producerName }}</div>
        </div>
        <div class="pair">
          <div class="lbl">Hectáreas</div>
          <div class="val">{{ farmDetail.hectares | number:'1.0-2' }}</div>
        </div>
        <div class="pair">
          <div class="lbl">Altitud (msnm)</div>
          <div class="val">{{ farmDetail.altitude | number:'1.0-0' }}</div>
        </div>
        <div class="pair">
          <div class="lbl">Coordenadas</div>
          <div class="val">
            {{ farmDetail.latitude | number:'1.4-4' }},
            {{ farmDetail.longitude | number:'1.4-4' }}
          </div>
        </div>
      </div>

      <div class="block actions" *ngIf="googleMapsLink">
        <ion-button expand="block" color="primary" fill="solid" [href]="googleMapsLink" target="_blank">
          <ion-icon slot="start" name="navigate-outline"></ion-icon>
          Abrir en Maps
        </ion-button>
      </div>

      <div class="block map-block" *ngIf="hasValidCoordinates">
        <h3 class="h-title">Ubicación en mapa</h3>
        <div class="map-box">
          <div #mapContainer class="map"></div>
        </div>
        <p class="map-note">Marcador centrado con las coordenadas suministradas.</p>
      </div>
    </section>
  </div>

  <ng-template #errorState>
    <div class="error-state">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <p>No se pudo cargar la finca.</p>
      <ion-button fill="clear" (click)="navigateBack()">Volver</ion-button>
    </div>
  </ng-template>
</ion-content>
